# HeatCostAllocator
PowerShell script to get readings of Heat Cost Allocators ([doprimo-3 heating meters](https://www.ista.com/uk-2023/technology/heat-cost-allocators/)) operated by `ista Nederland B.V.` on a **per-day** and **per-meter** basis.

## Installation
```bash
git clone https://github.com/daniel0x00/HeatCostAllocator.git
```

## Requirements 
- PowerShell 7 or higher, [available for Windows, MacOS and Linux](https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.4).

## Usage
- Add your credentials to the [ista Nederland B.V. login portal](https://mijn.ista.nl/home/index) on the `usage.ps1` file, vars `$Username` and `$Password`. ([Don't have an account?](https://mijn.ista.nl/RegisterNewUser)).
- Adjust the billing period in the `usage.ps1` file if needed, on the vars `$BillingPeriodYear`, `$startDate` and `$endDate`.
- By default, the script will get the heating readings broken down by day and by the full billing period. 
- It is recommended to export once a week: **every Tuesday night**. If you schedule the execution of `usage.ps1` in a cron job to every Tuesday, you will export **both** the readings as a **daily basis** (`DailyBasis` file) as well as the **full billing period** (`FullPeriodBasis` file).
- The `FullPeriodBasis` file will match what is shown in the portal.
- Run the script by dot-sourcing it:

```powershell
PS > . .\usage.ps1

# This will create two CSV files with the readings of the radiator's Heat Cost Allocators in your current directory: one with daily-basis readings and another with full-period readings.
# E.g.:
# `DailyBasis_BillingPeriodYear_2024_ExportedAt_2024-12-31_HCAReadings.csv`
# `FullPeriodBasis_BillingPeriodYear_2024_ExportedAt_2024-12-31_HCAReadings.csv`
# You also have available the variables `$dailyData` and `$fullData` which contains the readings as PowerShell object.
```

```powershell
PS > . .\usage.ps1
PS > $fullData | select -Last 1 | fl

CurEndTimestamp            : 1735513200
RequestedAtTimestamp       : 1735641355
RequestedBillingPeriodYear : 2024
MeterId                    : <redacted>
MeterNr                    : <redacted>
BillingPeriodId            : 2024
RadNr                      : 6
Position                   : Living room
TransferLoss               : 0
Multiply                   : 1
Reduction                  : 35
CalcFactor                 : 0.55
BsDate                     : 29-12-2024
EsDate                     : 30-12-2024
BeginValue                 : 705
EndValue                   : 724.35
CValue                     : 19.35
CCValue                    : 11
CCDValue                   : 7              
DecPos                     : 0
SValR                      : 0
EvalR                      : 92
serviceId                  : 1
Order                      : 1
ArtNr                      : <redacted>
DisplayName                : <redacted>
Address                    : <redacted>
Zip                        : <redacted>
Cuid                       : <redacted>
CurStart                   : 29-12-2024
CurEnd                     : 30-12-2024
TotalNow                   : 30

```

## Column explanation

Unofficial (best-guess effort) explanation of the columns generated by the script.

| Column | Description | Belongs to official API? |
|---|---|---|
| CurEndTimestamp | Represents the time in Unix format of the `CurEnd` date. Output as first column, so a Big Data tool (like Splunk) picks it up as event time. | No. Introduced as a helper column. |
| RequestedAtTimestamp | Represents the time at which the request was made to the API. | No. Introduced as a helper column. |
| RequestedBillingPeriodYear | Represents the billing period parameter passed to the API requests. | No. Introduced as a helper column. The API will output `BillingPeriodId` on the response. |
| Period | Represents the period of export. Can be `Daily` -indicating daily readings- or `Full` -indicating full billing period readings-. | No. Introduced as a helper column. |
| BeginValue | Meter reading as it was seen on `BsDate` date. | Yes |
| EndValue | Meter reading as it was seen on `EsDate` date. | Yes |
| CValue | Difference `EndValue`-`BeginValue` | Yes |
| CCDValue | This is the amount of units you're going to be billed for, after the application of `Reduction`, `CalcFactor` and `Multiply`. **IMPORTANT: this value CANNOT be used on the DailyBasis export as the calculation will be different than on the FullPeriod export**. | Yes |